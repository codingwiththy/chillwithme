<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Color Music Player üé®üéµ</title>

    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #000;
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
        user-select: none;
      }

      #dynamic-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, #222 0%, #000 80%);
        transition: background 0.8s ease;
        z-index: -2;
      }

      #colorWheel {
        cursor: crosshair;
        border-radius: 50%;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
      }

      #visualizer {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 200px;
        pointer-events: none;
      }

      #downloadBtn {
        position: absolute;
        bottom: 30px;
        right: 30px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        backdrop-filter: blur(4px);
        transition: 0.3s;
      }

      #downloadBtn:hover {
        background: rgba(255, 255, 255, 0.4);
      }
    </style>
  </head>

  <body>
    <div id="dynamic-bg"></div>
    <canvas id="colorWheel" width="400" height="400"></canvas>
    <canvas id="visualizer"></canvas>

    <audio id="audio"></audio>
    <button id="downloadBtn">T·∫£i b√†i ƒëang ph√°t</button>

    <script>
      const canvas = document.getElementById("colorWheel");
      const ctx = canvas.getContext("2d");
      const visualCanvas = document.getElementById("visualizer");
      const vctx = visualCanvas.getContext("2d");
      const audio = document.getElementById("audio");
      const bg = document.getElementById("dynamic-bg");
      const downloadBtn = document.getElementById("downloadBtn");

      let audioCtx, analyser, bufferLength, dataArray;

      /* ========== V·∫º V√íNG TR√íN M√ÄU ========== */
      function drawColorWheel() {
        const radius = canvas.width / 2;
        const image = ctx.createImageData(canvas.width, canvas.height);
        const data = image.data;

        for (let y = -radius; y < radius; y++) {
          for (let x = -radius; x < radius; x++) {
            const dist = Math.sqrt(x * x + y * y);
            if (dist <= radius) {
              const angle = Math.atan2(y, x) + Math.PI;
              const hue = (angle * 180) / Math.PI;
              const sat = dist / radius;
              const { r, g, b } = hsvToRgb(hue, sat, 1);
              const px = (y + radius) * canvas.width + (x + radius);
              data[4 * px] = r;
              data[4 * px + 1] = g;
              data[4 * px + 2] = b;
              data[4 * px + 3] = 255;
            }
          }
        }

        ctx.putImageData(image, 0, 0);
      }

      function hsvToRgb(h, s, v) {
        let f = (n, k = (n + h / 60) % 6) =>
          v - v * s * Math.max(Math.min(k, 4 - k, 1), 0);
        return {
          r: Math.round(f(5) * 255),
          g: Math.round(f(3) * 255),
          b: Math.round(f(1) * 255),
        };
      }

      drawColorWheel();

      /* ========== DANH S√ÅCH NH·∫†C ========== */
      const musicMap = [
        { name: "Rock", file: "./Rock (Purplish Red).mp3", range: [0, 40] },
        {
          name: "Jazzy Blues",
          file: "./Jazzy Blues (Yellowish Orange).mp3",
          range: [40, 70],
        },
        { name: "Country", file: "./Country (Green).mp3", range: [70, 150] },
        { name: "./Country (Greenish Blue).mp3", range: [130, 180] },
        { name: "Blues", file: "./Blues (Blue).mp3", range: [180, 260] },
        {
          name: "Eastern Blues",
          file: "./Eastern Blues (Whiteish Blue).mp3",
          range: [260, 320],
        },
      ];

      /* ========== VISUALIZER ========== */
      function setupVisualizer() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaElementSource(audio);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;

        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        drawVisualizer();
      }

      function drawVisualizer() {
        requestAnimationFrame(drawVisualizer);
        if (!analyser) return;

        analyser.getByteFrequencyData(dataArray);
        const width = (visualCanvas.width = window.innerWidth);
        const height = visualCanvas.height;
        vctx.clearRect(0, 0, width, height);

        const barWidth = (width / bufferLength) * 1.3;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const barHeight = dataArray[i];
          vctx.fillStyle = "rgba(255,255,255,0.5)";
          vctx.fillRect(x, height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      }

      /* ========== CLICK ‚Üí PH√ÅT NH·∫†C THEO M√ÄU ========== */
      canvas.addEventListener("mousedown", (event) => {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const [r, g, b] = pixel;

        bg.style.background = `radial-gradient(circle, rgba(${r},${g},${b},0.35) 0%, #000 75%)`;

        const hue = rgbToHue(r, g, b);
        playMusicByHue(hue);
      });

      function playMusicByHue(hue) {
        const song = musicMap.find(
          (item) => hue >= item.range[0] && hue <= item.range[1]
        );
        if (song) {
          audio.src = song.file;
          audio.play();
          console.log("üéµ Ph√°t:", song.name);
          if (!audioCtx) setupVisualizer();
        } else {
          console.log("Kh√¥ng c√≥ b√†i ph√π h·ª£p m√†u n√†y!");
        }
      }

      function rgbToHue(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        const max = Math.max(r, g, b),
          min = Math.min(r, g, b);
        let h;
        if (max === min) h = 0;
        else if (max === r) h = (60 * ((g - b) / (max - min)) + 360) % 360;
        else if (max === g) h = (60 * ((b - r) / (max - min)) + 120) % 360;
        else h = (60 * ((r - g) / (max - min)) + 240) % 360;
        return h;
      }

      /* ========== N√öT T·∫¢I NH·∫†C ========== */
      downloadBtn.addEventListener("click", () => {
        if (audio.src) {
          const a = document.createElement("a");
          a.href = audio.src;
          a.download = audio.src.split("/").pop();
          a.click();
        } else {
          alert("Ch∆∞a c√≥ b√†i n√†o ƒëang ph√°t!");
        }
      });
    </script>
  </body>
</html>
